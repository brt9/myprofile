services:
  php:
    container_name: ets-sistema-php
    build:
      context: .
      dockerfile: ./docker/php/Dockerfile
    restart: no
    volumes:
      - ./:/var/www:delegated
      - vendor_cache:/var/www/vendor
      - bootstrap_cache:/var/www/bootstrap/cache
      - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini:ro
    ports:
      - "9000:9000"   # PHP-FPM
      # - "5137:5137" # REMOVIDO: Vite nÃ£o deve ser exposto aqui
    networks:
      - ets-sistema-network
    depends_on:
      - mysql
    environment:
      TZ: America/Fortaleza
    extra_hosts:
      - "host.docker.internal:host-gateway"

  nginx:
    container_name: ets-sistema-nginx
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    restart: no
    ports:
      - "8080:80"
      # - "443:443"
    volumes:
      - ./:/var/www:delegated,ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - ets-sistema-network
    depends_on:
      - php
    extra_hosts:
      - "host.docker.internal:host-gateway"

  mysql:
    container_name: ets-sistema-mysql
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    command: --default-authentication-plugin=mysql_native_password
    restart: no
    volumes:
      - ets-sistema-data:/var/lib/mysql:cached
      - ./docker/mysql/my.cnf:/etc/mysql/my.cnf:ro
    networks:
      - ets-sistema-network
    ports:
      - "3307:3306"   # recomendado no Windows; evite conflito com MySQL local
    environment:
      MYSQL_DATABASE: myprofile_database
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      TZ: America/Fortaleza
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -proot --silent"]
      interval: 5s
      timeout: 3s
      retries: 30

  node:
    image: node:20
    container_name: ets-sistema-node
    working_dir: /var/www
    command: >
      sh -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi;
              npm run dev -- --host 0.0.0.0 --port 5137"
    ports:
      - "5137:5137"   # Vite/HMR no host (como era)
    volumes:
      - ./:/var/www:delegated
      - vendor_cache:/var/www/vendor
      - node_modules_cache:/var/www/node_modules
    depends_on:
      - php
    networks:
      - ets-sistema-network
    environment:
      CHOKIDAR_USEPOLLING: "true"

networks:
  ets-sistema-network:
    driver: bridge

volumes:
  ets-sistema-data:
    driver: local
  vendor_cache:
    driver: local
  bootstrap_cache:
    driver: local
  node_modules_cache:
    driver: local